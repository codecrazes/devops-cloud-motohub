trigger:
  branches:
    include:
      - main

variables:
- group: vg-motohub

pool:
  name: self-hosted-linux

stages:
- stage: Build
  displayName: BuildTestPublish
  jobs:
  - job: BuildTest
    steps:
    - script: |
        java -version
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
      displayName: CheckJava
    - task: Maven@3
      inputs:
        mavenPomFile: app/pom.xml
        goals: clean test package
        options: -Dspring.profiles.active=test
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        javaHomeOption: Path
        jdkDirectory: /usr/lib/jvm/java-17-openjdk-amd64
        jdkArchitectureOption: x64
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: app/target
        artifactName: drop
        publishLocation: Container

- stage: Image
  displayName: BuildAndPushDocker
  dependsOn: Build
  jobs:
  - job: BuildAndPushImage
    steps:
    - task: AzureCLI@2
      inputs:
        azureSubscription: sc-azurerm-motohub
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          ACR_LOGIN_SERVER=$(az acr show --name $(ACR_NAME) --query loginServer -o tsv)
          ACR_USER=$(az acr credential show --name $(ACR_NAME) --query username -o tsv)
          ACR_PASS=$(az acr credential show --name $(ACR_NAME) --query 'passwords[0].value' -o tsv)
          echo "$ACR_PASS" | sudo -n docker login "$ACR_LOGIN_SERVER" --username "$ACR_USER" --password-stdin
          sudo -n docker build -t "$ACR_LOGIN_SERVER/motohub:$(Build.BuildId)" -t "$ACR_LOGIN_SERVER/motohub:latest" app
          sudo -n docker push "$ACR_LOGIN_SERVER/motohub:$(Build.BuildId)"
          sudo -n docker push "$ACR_LOGIN_SERVER/motohub:latest"

- stage: Deploy
  displayName: DeployACI
  dependsOn: Image
  jobs:
  - job: DeployACI
    steps:
    - task: AzureCLI@2
      inputs:
        azureSubscription: sc-azurerm-motohub
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail
          if [ -z "$(ACI_NAME)" ] || [ -z "$(DNS_LABEL)" ] || [ -z "$(MYSQL_HOST)" ]; then
            exit 2
          fi
          st=$(az provider show --namespace Microsoft.ContainerInstance --query registrationState -o tsv || echo NotRegistered)
          [ "$st" = "Registered" ] || exit 2
          az group create -n $(AZ_RG) -l $(AZ_LOCATION) -o none
          ACR_LOGIN_SERVER=$(az acr show --name $(ACR_NAME) --query loginServer -o tsv)
          IMAGE="$ACR_LOGIN_SERVER/motohub:$(Build.BuildId)"
          az container delete -g $(AZ_RG) -n $(ACI_NAME) --yes || true
          DATASOURCE_URL="jdbc:mysql://$(MYSQL_HOST):3306/$(MYSQL_DB)?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"
          az container create \
            -g $(AZ_RG) \
            -n $(ACI_NAME) \
            --image "$IMAGE" \
            --cpu 1 \
            --memory 1.5 \
            --os-type Linux \
            --restart-policy Always \
            --registry-login-server "$ACR_LOGIN_SERVER" \
            --registry-username "$(ACR_USERNAME)" \
            --registry-password "$(ACR_PASSWORD)" \
            --dns-name-label $(DNS_LABEL) \
            --ports $(APP_PORT) \
            --environment-variables \
              APP_PORT=$(APP_PORT) \
              DB_HOST=$(MYSQL_HOST) \
              DB_PORT=3306 \
              SPRING_FLYWAY_ENABLED=true \
              SPRING_JPA_HIBERNATE_DDL_AUTO=none \
              SPRING_DATASOURCE_URL="$DATASOURCE_URL" \
            --secure-environment-variables \
              SPRING_DATASOURCE_USERNAME=$(MYSQL_USER) \
              SPRING_DATASOURCE_PASSWORD=$(MYSQL_PASSWORD)
          for i in $(seq 1 60); do
            ps=$(az container show -g $(AZ_RG) -n $(ACI_NAME) --query "provisioningState" -o tsv || echo Unknown)
            st=$(az container show -g $(AZ_RG) -n $(ACI_NAME) --query "instanceView.state" -o tsv || echo Unknown)
            [ "$ps" = "Succeeded" ] && [ "$st" = "Running" ] && break
            sleep 5
          done
          ps=$(az container show -g $(AZ_RG) -n $(ACI_NAME) --query "provisioningState" -o tsv || echo Unknown)
          st=$(az container show -g $(AZ_RG) -n $(ACI_NAME) --query "instanceView.state" -o tsv || echo Unknown)
          if [ "$ps" != "Succeeded" ] || [ "$st" != "Running" ]; then
            az container show -g $(AZ_RG) -n $(ACI_NAME) --query "containers[].instanceView.events" -o jsonc || true
            az container logs -g $(AZ_RG) -n $(ACI_NAME) --container-name motohub-api || true
            exit 3
          fi
          FQDN=$(az container show -g $(AZ_RG) -n $(ACI_NAME) --query "ipAddress.fqdn" -o tsv)
          echo "FQDN=$FQDN PORT=$(APP_PORT)"