trigger:
  branches:
    include:
      - main

variables:
- group: vg-motohub
- name: dockerServiceConnection
  value: sc-acr-motohub

pool:
  name: self-hosted-linux

stages:
- stage: Build
  displayName: BuildTestPublish
  jobs:
  - job: BuildTest
    steps:
    - script: |
        java -version
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
      displayName: CheckJava

    - task: Maven@4
      displayName: Maven Clean Test Package
      inputs:
        mavenPomFile: app/pom.xml
        goals: clean test package
        options: -Dspring.profiles.active=test
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        javaHomeOption: Path
        jdkDirectory: /usr/lib/jvm/java-17-openjdk-amd64
        jdkArchitectureOption: x64

    - task: PublishBuildArtifacts@1
      displayName: Publish JAR Artifact
      inputs:
        pathToPublish: app/target/*.jar
        artifactName: drop
        publishLocation: Container

- stage: Image
  displayName: BuildAndPushDocker
  dependsOn: Build
  jobs:
  - job: BuildAndPushImage
    steps:
    - download: current
      artifact: drop

    - task: Docker@2
      displayName: Build and Push Docker Image
      inputs:
        command: buildAndPush
        containerRegistry: $(dockerServiceConnection)
        repository: motohub
        dockerfile: app/Dockerfile
        buildContext: app
        tags: |
          $(Build.BuildId)
          latest

- stage: Deploy
  displayName: DeployACI
  dependsOn: Image
  jobs:
  - job: DeployACI
    steps:
    - task: AzureCLI@2
      displayName: Deploy to Azure Container Instances
      env:
        SPRING_DATASOURCE_USERNAME: $(SPRING_DATASOURCE_USERNAME)
        SPRING_DATASOURCE_PASSWORD: $(SPRING_DATASOURCE_PASSWORD)
        MYSQL_HOST: $(MYSQL_HOST)
        MYSQL_DB: $(MYSQL_DB)
        AZ_RG: $(AZ_RG)
        AZ_LOCATION: $(AZ_LOCATION)
        ACR_NAME: $(ACR_NAME)
        ACI_NAME: $(ACI_NAME)
        DNS_LABEL: $(DNS_LABEL)
        APP_PORT: $(APP_PORT)
        ACR_USERNAME: $(ACR_USERNAME)
        ACR_PASSWORD: $(ACR_PASSWORD)
      inputs:
        azureSubscription: sc-azurerm-motohub
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail

          if [ -z "${ACI_NAME}" ] || [ -z "${DNS_LABEL}" ] || [ -z "${MYSQL_HOST}" ]; then
            echo "Variáveis obrigatórias não definidas."
            exit 2
          fi

          st=$(az provider show --namespace Microsoft.ContainerInstance --query registrationState -o tsv || echo NotRegistered)
          [ "$st" = "Registered" ] || exit 2

          az group create -n "${AZ_RG}" -l "${AZ_LOCATION}" -o none

          ACR_LOGIN_SERVER=$(az acr show --name "${ACR_NAME}" --query loginServer -o tsv)
          IMAGE="${ACR_LOGIN_SERVER}/motohub:$(Build.BuildId)"

          az container delete -g "${AZ_RG}" -n "${ACI_NAME}" --yes || true

          DATASOURCE_URL="jdbc:mysql://${MYSQL_HOST}:3306/${MYSQL_DB}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"

          az container create \
            -g "${AZ_RG}" \
            -n "${ACI_NAME}" \
            --image "${IMAGE}" \
            --cpu 1 \
            --memory 1.5 \
            --os-type Linux \
            --restart-policy Always \
            --registry-login-server "${ACR_LOGIN_SERVER}" \
            --registry-username "${ACR_USERNAME}" \
            --registry-password "${ACR_PASSWORD}" \
            --dns-name-label "${DNS_LABEL}" \
            --ports "${APP_PORT}" \
            --environment-variables \
              APP_PORT="${APP_PORT}" \
              DB_HOST="${MYSQL_HOST}" \
              DB_PORT=3306 \
              SPRING_FLYWAY_ENABLED=false \
              SPRING_JPA_HIBERNATE_DDL_AUTO=none \
              SPRING_DATASOURCE_URL="${DATASOURCE_URL}" \
            --secure-environment-variables \
              SPRING_DATASOURCE_USERNAME="${SPRING_DATASOURCE_USERNAME}" \
              SPRING_DATASOURCE_PASSWORD="${SPRING_DATASOURCE_PASSWORD}"

          for i in $(seq 1 60); do
            ps=$(az container show -g "${AZ_RG}" -n "${ACI_NAME}" --query "provisioningState" -o tsv || echo Unknown)
            st=$(az container show -g "${AZ_RG}" -n "${ACI_NAME}" --query "instanceView.state" -o tsv || echo Unknown)
            [ "$ps" = "Succeeded" ] && [ "$st" = "Running" ] && break
            sleep 5
          done

          ps=$(az container show -g "${AZ_RG}" -n "${ACI_NAME}" --query "provisioningState" -o tsv || echo Unknown)
          st=$(az container show -g "${AZ_RG}" -n "${ACI_NAME}" --query "instanceView.state" -o tsv || echo Unknown)

          if [ "$ps" != "Succeeded" ] || [ "$st" != "Running" ]; then
            az container show -g "${AZ_RG}" -n "${ACI_NAME}" --query "containers[].instanceView.events" -o jsonc || true
            az container logs -g "${AZ_RG}" -n "${ACI_NAME}" --container-name motohub-api || true
            exit 3
          fi

          FQDN=$(az container show -g "${AZ_RG}" -n "${ACI_NAME}" --query "ipAddress.fqdn" -o tsv)
          echo "FQDN=${FQDN} PORT=${APP_PORT}"
